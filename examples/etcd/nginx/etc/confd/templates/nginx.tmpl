# for each service, create a backend
{{ range $app := lsdir "/" }}
upstream {{ $app }} {
    # write the health service address:port pairs for this backend
    {{ range $inst := lsdir (print "/" $app)  }}{{ $service := json (getv (print "/" $app "/" $inst "/service" )) }}
    server {{ $service.address }}:{{ $service.port }};
    {{end}}
}
{{end}}

server {
    listen       80;
    server_name  _;

    # if you have http_stub_status_module compiled-in, then
    # this would be a good place to use /nginx_status
    location /health.txt {
        add_header content-type "text/html";
        alias /usr/share/nginx/html/index.html;
    }

    {{ range $app := lsdir "/" }}
    location = /{{ $app }} {
        return 302 /{{ $app }}/;
    }
    location /{{ $app }} {
        proxy_pass http://{{ $app }}/;
        proxy_redirect off;
    }
    {{end}}
}
